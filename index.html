<html>
<head>
<script type='text/javascript'>
var canvas;
var c;
var p = new Array();
var toload = 1;
var totalload = 1;
var zoom = 2;
var zoomtrg = 2;
var cam = {x: 0, y: 0};
var waitforit = 50;
var players = 1;
var camid = 0;
var waitcam = 0;

// User input
var hascontrol = 0;
var isshooting = false;
var isaccelerating = false;
var iskeyboardcontrol = false;
var isturning = 0;
var ispaused = false;
var trg = {x: 0, y: 0};

var part = {
    'id': function(part_name) {
        switch(part_name) {
        case "hull1": return 0;
        case "hull2": return 1;
        case "hull3": return 2;
        case "engine1": return 3;
        case "engine2": return 4;
        case "system1": return 5;
        case "blaster1left": return 6;
        case "blaster1right": return 7;
        case "blaster1": return 8;
        case "blast1": return 9;
        case "explosion1": return 10;
        case "explosion2": return 11;
        case "shield1": return 12;
        case "shield1broken": return 13;
        case "hull4": return 14;
        case "hull5": return 15;
        case "system2": return 16;
        case "hull1broken": return 17;
        case "hull2broken": return 18;
        case "hull3broken": return 19;
        case "engine1broken": return 20;
        case "engine2broken": return 21;
        case "system1broken": return 22;
        case "blaster1leftbroken": return 23;
        case "blaster1rightbroken": return 24;
        case "blaster1broken": return 25;
        case "hull4broken": return 26;
        case "hull5broken": return 27;
        case "system2broken": return 28;
        
        // Scythe parts
        case "vanduul/scythe_big_gun": return 29;
        case "vanduul/scythe_blade": return 30;
        case "vanduul/scythe_gun_arm": return 31;
        case "vanduul/scythe_medium_gun": return 32;
        case "vanduul/scythe_blade_arm": return 33;
        case "vanduul/scythe_cockpit": return 34;
        case "vanduul/scythe_main_hull": return 35;
        case "vanduul/scythe_small_gun": return 36;
        case "vanduul/scythe_thruster": return 37;
        case "vanduul/scythe_big_gunbroken": return 38;
        case "vanduul/scythe_bladebroken": return 39;
        case "vanduul/scythe_gun_armbroken": return 40;
        case "vanduul/scythe_medium_gunbroken": return 41;
        case "vanduul/scythe_blade_armbroken": return 42;
        case "vanduul/scythe_cockpitbroken": return 43;
        case "vanduul/scythe_main_hullbroken": return 44;
        case "vanduul/scythe_small_gunbroken": return 45;
        case "vanduul/scythe_thrusterbroken": return 46;
        
        // More blasts
        case "blast2": return 47;
        case "blast3": return 48;
        
        // Hornet parts
        case "anvil/hornet_ball_turret": return 49;
        case "anvil/hornet_big_gun": return 50;
        case "anvil/hornet_cockpit": return 51;
        case "anvil/hornet_intake_left": return 52;
        case "anvil/hornet_intake_right": return 53;
        case "anvil/hornet_main_hull": return 54;
        case "anvil/hornet_tail": return 55;
        case "anvil/hornet_thruster": return 56;
        case "anvil/hornet_wings_left": return 57;
        case "anvil/hornet_wings_right": return 58;
        case "anvil/hornet_ball_turretbroken": return 59;
        case "anvil/hornet_big_gunbroken": return 60;
        case "anvil/hornet_cockpitbroken": return 61;
        case "anvil/hornet_intake_leftbroken": return 62;
        case "anvil/hornet_intake_rightbroken": return 63;
        case "anvil/hornet_main_hullbroken": return 64;
        case "anvil/hornet_tailbroken": return 65;
        case "anvil/hornet_thrusterbroken": return 66;
        case "anvil/hornet_wings_leftbroken": return 67;
        case "anvil/hornet_wings_rightbroken": return 68;
        
        // Aurora parts
        case "rsi/aurora_cockpit": return 69;
        case "rsi/aurora_cockpitbroken": return 70;
        case "rsi/aurora_intake_left": return 71;
        case "rsi/aurora_intake_leftbroken": return 72;
        case "rsi/aurora_intake_right": return 73;
        case "rsi/aurora_intake_rightbroken": return 74;
        case "rsi/aurora_main_hull": return 75;
        case "rsi/aurora_main_hullbroken": return 76;
        case "rsi/aurora_thruster": return 77;
        case "rsi/aurora_thrusterbroken": return 78;
        case "rsi/aurora_wing_left": return 79;
        case "rsi/aurora_wing_leftbroken": return 80;
        case "rsi/aurora_wing_right": return 81;
        case "rsi/aurora_wing_rightbroken": return 82;
        
        // 300i parts
        case "origin/300i_cockpit": return 83;
        case "origin/300i_cockpitbroken": return 84;
        case "origin/300i_hull_front": return 85;
        case "origin/300i_hull_frontbroken": return 86;
        case "origin/300i_hull_rear": return 87;
        case "origin/300i_hull_rearbroken": return 88;
        case "origin/300i_thruster": return 89;
        case "origin/300i_thrusterbroken": return 90;
        case "origin/300i_wing_left": return 91;
        case "origin/300i_wing_leftbroken": return 92;
        case "origin/300i_wing_right": return 93;
        case "origin/300i_wing_rightbroken": return 94;
        case "origin/300i_wing_top": return 95;
        case "origin/300i_wing_topbroken": return 96;
        
        // Glaive parts
        case "vanduul/scythe_big_gun_left": return 97;
        case "vanduul/scythe_blade_left": return 98;
        case "vanduul/scythe_blade_arm_left": return 99;
        case "vanduul/scythe_big_gun_leftbroken": return 100;
        case "vanduul/scythe_blade_leftbroken": return 101;
        case "vanduul/scythe_blade_arm_leftbroken": return 102;
        
        // Shields
        case "shield2": return 103;
        case "shield2broken": return 104;
        case "shield3": return 105;
        case "shield3broken": return 106;
        case "shield4": return 107;
        case "shield4broken": return 108;
        
        default: 
            document.getElementById('debug').innerHTML = "part.id('" + part_name + "'): part not found!";
            return -1;
        }
    },
    'name': function(part_id) {
        switch(part_id) {
        case 0: return "hull1";
        case 1: return "hull2";
        case 2: return "hull3";
        case 3: return "engine1";
        case 4: return "engine2";
        case 5: return "system1";
        case 6: return "blaster1left";
        case 7: return "blaster1right";
        case 8: return "blaster1";
        case 9: return "blast1";
        case 10: return "explosion1";
        case 11: return "explosion2";
        case 12: return "shield1";
        case 13: return "shield1broken";
        case 14: return "hull4";
        case 15: return "hull5";
        case 16: return "system2";
        case 17: return "hull1broken";
        case 18: return "hull2broken";
        case 19: return "hull3broken";
        case 20: return "engine1broken";
        case 21: return "engine2broken";
        case 22: return "system1broken";
        case 23: return "blaster1leftbroken";
        case 24: return "blaster1rightbroken";
        case 25: return "blaster1broken";
        case 26: return "hull4broken";
        case 27: return "hull5broken";
        case 28: return "system2broken";
        
        // Scythe parts
        case 29: return "vanduul/scythe_big_gun";
        case 30: return "vanduul/scythe_blade";
        case 31: return "vanduul/scythe_gun_arm";
        case 32: return "vanduul/scythe_medium_gun";
        case 33: return "vanduul/scythe_blade_arm";
        case 34: return "vanduul/scythe_cockpit";
        case 35: return "vanduul/scythe_main_hull";
        case 36: return "vanduul/scythe_small_gun";
        case 37: return "vanduul/scythe_thruster";
        case 38: return "vanduul/scythe_big_gunbroken";
        case 39: return "vanduul/scythe_bladebroken";
        case 40: return "vanduul/scythe_gun_armbroken";
        case 41: return "vanduul/scythe_medium_gunbroken";
        case 42: return "vanduul/scythe_blade_armbroken";
        case 43: return "vanduul/scythe_cockpitbroken";
        case 44: return "vanduul/scythe_main_hullbroken";
        case 45: return "vanduul/scythe_small_gunbroken";
        case 46: return "vanduul/scythe_thrusterbroken";
        
        // More blasts
        case 47: return "blast2";
        case 48: return "blast3";
        
        // Hornet parts
        case 49: return "anvil/hornet_ball_turret";
        case 50: return "anvil/hornet_big_gun";
        case 51: return "anvil/hornet_cockpit";
        case 52: return "anvil/hornet_intake_left";
        case 53: return "anvil/hornet_intake_right";
        case 54: return "anvil/hornet_main_hull";
        case 55: return "anvil/hornet_tail";
        case 56: return "anvil/hornet_thruster";
        case 57: return "anvil/hornet_wings_left";
        case 58: return "anvil/hornet_wings_right";
        case 59: return "anvil/hornet_ball_turretbroken";
        case 60: return "anvil/hornet_big_gunbroken";
        case 61: return "anvil/hornet_cockpitbroken";
        case 62: return "anvil/hornet_intake_leftbroken";
        case 63: return "anvil/hornet_intake_rightbroken";
        case 64: return "anvil/hornet_main_hullbroken";
        case 65: return "anvil/hornet_tailbroken";
        case 66: return "anvil/hornet_thrusterbroken";
        case 67: return "anvil/hornet_wings_leftbroken";
        case 68: return "anvil/hornet_wings_rightbroken";
        
        // Aurora parts
        case 69: return "rsi/aurora_cockpit";
        case 70: return "rsi/aurora_cockpitbroken";
        case 71: return "rsi/aurora_intake_left";
        case 72: return "rsi/aurora_intake_leftbroken";
        case 73: return "rsi/aurora_intake_right";
        case 74: return "rsi/aurora_intake_rightbroken";
        case 75: return "rsi/aurora_main_hull";
        case 76: return "rsi/aurora_main_hullbroken";
        case 77: return "rsi/aurora_thruster";
        case 78: return "rsi/aurora_thrusterbroken";
        case 79: return "rsi/aurora_wing_left";
        case 80: return "rsi/aurora_wing_leftbroken";
        case 81: return "rsi/aurora_wing_right";
        case 82: return "rsi/aurora_wing_rightbroken";
        
        // 300i parts
        case 83: return "origin/300i_cockpit";
        case 84: return "origin/300i_cockpitbroken";
        case 85: return "origin/300i_hull_front";
        case 86: return "origin/300i_hull_frontbroken";
        case 87: return "origin/300i_hull_rear";
        case 88: return "origin/300i_hull_rearbroken";
        case 89: return "origin/300i_thruster";
        case 90: return "origin/300i_thrusterbroken";
        case 91: return "origin/300i_wing_left";
        case 92: return "origin/300i_wing_leftbroken";
        case 93: return "origin/300i_wing_right";
        case 94: return "origin/300i_wing_rightbroken";
        case 95: return "origin/300i_wing_top";
        case 96: return "origin/300i_wing_topbroken";
        
        // Glaive parts
        case 97: return "vanduul/scythe_big_gun_left";
        case 98: return "vanduul/scythe_blade_left";
        case 99: return "vanduul/scythe_blade_arm_left";
        case 100: return "vanduul/scythe_big_gun_leftbroken";
        case 101: return "vanduul/scythe_blade_leftbroken";
        case 102: return "vanduul/scythe_blade_arm_leftbroken";
        
        // Shields
        case 103: return "shield2";
        case 104: return "shield2broken";
        case 105: return "shield3";
        case 106: return "shield3broken";
        case 107: return "shield4";
        case 108: return "shield4broken";
        
        default: 
            document.getElementById('debug').innerHTML = "part.name(" + part_id + "): part not found!";
            return -1;
        }
    },
    'init': function() {
        for(var i = 0; i < 109; i++) {
          toload++;
          totalload++;
          p[i] = new Image();
          p[i].onload = doneload();
          p[i].src = part.name(i) + ".png";
        }
    },
    'draw': function(part_id, scale) {
        if(scale) c.scale(scale, scale);
        c.translate(-p[part_id].width * 0.5, -p[part_id].height * 0.5);
        c.drawImage(p[part_id], 0, 0);
    },
    'create': function(part_name, posx, posy, parent_id) {
        switch(part_name) {
        case "hull1": return {part: part_name, x: posx, y: posy, hlt: 2.0, parent: parent_id};
        case "hull2": return {part: part_name, x: posx, y: posy, hlt: 2.0, parent: parent_id};
        case "hull3": return {part: part_name, x: posx, y: posy, hlt: 1.3, parent: parent_id};
        case "engine1": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "engine2": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "system1": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "blaster1left": return {part: part_name, x: posx, y: posy, hlt: 0.7, parent: parent_id};
        case "blaster1right": return {part: part_name, x: posx, y: posy, hlt: 0.7, parent: parent_id};
        case "blaster1": return {part: part_name, x: posx, y: posy, hlt: 0.7, parent: parent_id};
        case "shield1": return {part: part_name, x: posx, y: posy, hlt: 3.0, parent: parent_id};
        case "hull4": return {part: part_name, x: posx, y: posy, hlt: 2.0, parent: parent_id};
        case "hull5": return {part: part_name, x: posx, y: posy, hlt: 1.3, parent: parent_id};
        case "system2": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        
        // Scythe parts
        case "vanduul/scythe_big_gun": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "vanduul/scythe_blade": return {part: part_name, x: posx, y: posy, hlt: 2.0, parent: parent_id};
        case "vanduul/scythe_gun_arm": return {part: part_name, x: posx, y: posy, hlt: 1.5, parent: parent_id};
        case "vanduul/scythe_medium_gun": return {part: part_name, x: posx, y: posy, hlt: 0.7, parent: parent_id};
        case "vanduul/scythe_blade_arm": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "vanduul/scythe_cockpit": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "vanduul/scythe_main_hull": return {part: part_name, x: posx, y: posy, hlt: 3.0, parent: parent_id};
        case "vanduul/scythe_small_gun": return {part: part_name, x: posx, y: posy, hlt: 0.5, parent: parent_id};
        case "vanduul/scythe_thruster": return {part: part_name, x: posx, y: posy, hlt: 1.5, parent: parent_id};
        
        // Hornet parts
        case "anvil/hornet_ball_turret": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "anvil/hornet_big_gun": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "anvil/hornet_cockpit": return {part: part_name, x: posx, y: posy, hlt: 1.5, parent: parent_id};
        case "anvil/hornet_intake_left": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "anvil/hornet_intake_right": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "anvil/hornet_main_hull": return {part: part_name, x: posx, y: posy, hlt: 2.5, parent: parent_id};
        case "anvil/hornet_tail": return {part: part_name, x: posx, y: posy, hlt: 1.5, parent: parent_id};
        case "anvil/hornet_thruster": return {part: part_name, x: posx, y: posy, hlt: 1.2, parent: parent_id};
        case "anvil/hornet_wings_left": return {part: part_name, x: posx, y: posy, hlt: 1.3, parent: parent_id};
        case "anvil/hornet_wings_right": return {part: part_name, x: posx, y: posy, hlt: 1.3, parent: parent_id};
        
        // Aurora parts
        case "rsi/aurora_cockpit": return {part: part_name, x: posx, y: posy, hlt: 1.5, parent: parent_id};
        case "rsi/aurora_intake_left": return {part: part_name, x: posx, y: posy, hlt: 0.7, parent: parent_id};
        case "rsi/aurora_intake_right": return {part: part_name, x: posx, y: posy, hlt: 0.7, parent: parent_id};
        case "rsi/aurora_main_hull": return {part: part_name, x: posx, y: posy, hlt: 2.0, parent: parent_id};
        case "rsi/aurora_thruster": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "rsi/aurora_wing_left": return {part: part_name, x: posx, y: posy, hlt: 0.5, parent: parent_id};
        case "rsi/aurora_wing_right": return {part: part_name, x: posx, y: posy, hlt: 0.5, parent: parent_id};
        
        // 300i parts
        case "origin/300i_cockpit": return {part: part_name, x: posx, y: posy, hlt: 1.7, parent: parent_id};
        case "origin/300i_hull_front": return {part: part_name, x: posx, y: posy, hlt: 2.5, parent: parent_id};
        case "origin/300i_hull_rear": return {part: part_name, x: posx, y: posy, hlt: 2.2, parent: parent_id};
        case "origin/300i_thruster": return {part: part_name, x: posx, y: posy, hlt: 1.2, parent: parent_id};
        case "origin/300i_wing_left": return {part: part_name, x: posx, y: posy, hlt: 0.6, parent: parent_id};
        case "origin/300i_wing_right": return {part: part_name, x: posx, y: posy, hlt: 0.6, parent: parent_id};
        case "origin/300i_wing_top": return {part: part_name, x: posx, y: posy, hlt: 0.6, parent: parent_id};
        
        // Glaive parts
        case "vanduul/scythe_big_gun_left": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        case "vanduul/scythe_blade_left": return {part: part_name, x: posx, y: posy, hlt: 2.0, parent: parent_id};
        case "vanduul/scythe_blade_arm_left": return {part: part_name, x: posx, y: posy, hlt: 1.0, parent: parent_id};
        
        // Shields
        case "shield2": return {part: part_name, x: posx, y: posy, hlt: 6.0, parent: parent_id};
        case "shield3": return {part: part_name, x: posx, y: posy, hlt: 9.0, parent: parent_id};
        case "shield4": return {part: part_name, x: posx, y: posy, hlt: 7.0, parent: parent_id};
        
        default: return "part.create('" + part_name + "'): part not found!";
        }
        
    }
};

function frag(pos, rot, col, typ, sub, del, spd) {
    this.pos = {x: 0, y: 0};
    this.spd = {x: 0, y: 0};
    this.rot = 0;
    this.del = 0;
    this.lif = 0;
    this.col = 0;
    this.typ = 0;
    this.sub = "";
    
    // Function for drawing this frag
    this.drawFrag = function() {
        if(this.lif > 0) {
            c.save();
            c.translate(this.pos.x, this.pos.y);
            c.rotate(this.rot);
            switch(this.typ) {
            case 0: part.draw(9); break;// Blast
            case 1: part.draw(10, 3.0 / 20.0 * this.lif + 0.1); break; // Explosion
            case 2: part.draw(11, 2.0 / 10.0 * this.lif + 0.1); break; // Engine fire
            case 3: part.draw(part.id(this.sub + "broken")); break; // Part
            case 4: part.draw(47); break; // Big blast
            case 5: part.draw(48); break; // Small blast
            }
            c.restore();
        }
    }
    
    // Move this frag
    this.moveFrag = function() {
        var spd = (ispaused ? 0.1 : 1.0);
        if(this.lif) {
            this.lif -= spd;
            if(this.lif) {
                
                // Movement
                this.pos.x += this.spd.x * spd;
                this.pos.y += this.spd.y * spd;
                this.rot += this.del * spd;
                
                // Hit
                var ppos;
                var psiz;
                var pdis;
                var pcpos;
                var pos;
                var dis;
                var prt;
                var partid;
                if((this.typ == 0 || this.typ == 4 || this.typ == 5) && !waitforit) for(var i = 0; i < a.length; i++) if(a[i].col != this.col && a[i].pts && this.lif > 0) {
                    
                    // Check if bullet is even near this ship
                    if(this.pos.x < a[i].pos.x + 50 && this.pos.x > a[i].pos.x - 50 && this.pos.y < a[i].pos.y + 50 && this.pos.y > a[i].pos.y - 50) {
                        
                        // Check what part of ship is hit
                        pdis = 1000;
                        prt = -1;
                        for(var u = 0; u < a[i].p.length; u++) if(a[i].p[u].hlt > 0.0 && this.lif > 0) {
                            ppos = {
                                x: a[i].pos.x + a[i].nrm.x * a[i].p[u].x - a[i].nrm.y * a[i].p[u].y,
                                y: a[i].pos.y + a[i].nrm.y * a[i].p[u].x + a[i].nrm.x * a[i].p[u].y
                            };
                            if(a[i].p[u].hlt < 0.2) partid = part.id(a[i].p[u].part + "broken");
                            else partid = part.id(a[i].p[u].part);
                            psiz = (p[partid].width + p[partid].height) / 4.0;
                            pos = {x: this.pos.x - ppos.x, y: this.pos.y - ppos.y};
                            dis = Math.sqrt(pos.x * pos.x + pos.y * pos.y) - psiz;
                            if(dis < psiz && dis < pdis) {
                                prt = u;
                                pdis = dis;
                                pcpos = {x: ppos.x, y: ppos.y};
                            }
                        }
                        
                        // If part is hit, add damage
                        if(prt != -1) {
                            this.lif = 0;
                            switch(this.typ) {
                            case 0: a[i].p[prt].hlt -= Math.random() + 0.3; break;
                            case 4: a[i].p[prt].hlt -= Math.random() + 0.5; break;
                            case 5: a[i].p[prt].hlt -= Math.random() + 0.15; break;
                            }
                            
                            // Create explosion
                            for(var u = 0; u < 3; u++) b.push(new frag(
                                {x: this.pos.x, y: this.pos.y},
                                Math.random() * 6.3,
                                this.col,
                                1
                            ));
                            
                            // Detatch broken part
                            if(a[i].p[prt].hlt <= 0.0) {
                                b.push(new frag(
                                    {x: pcpos.x, y: pcpos.y},
                                    a[i].rot,
                                    this.col,
                                    3, a[i].p[prt].part,
                                    a[i].del + Math.random() * 0.2 - 0.1,
                                    {x: a[i].spd.x + Math.random() * 8.0 - 4.0, y: a[i].spd.y + Math.random() * 8.0 - 4.0}
                                ));
                                a[i].p[prt].hlt = 0;
                            }
                        }
                    }
                }
            }
        }
    }
    
    if(pos && rot) {
        this.pos = pos;
        this.rot = rot;
        if(col) this.col = col;
        if(typ) this.typ = typ;
        if(sub) this.sub = sub;
        if(del) this.del = del;
        switch(this.typ) {
        case 0: this.lif = 90 + Math.random() * 20.0; break; // Blast
        case 1: this.lif = 15 + Math.random() * 10.0; break; // Explosion
        case 2: this.lif = 7 + Math.random() * 3.0; break; // Engine fire
        case 3: this.lif = 150 + Math.random() * 150.0; break; // Ship part
        case 4: this.lif = 90 + Math.random() * 20.0; break; // Big blast
        case 5: this.lif = 90 + Math.random() * 20.0; break; // Small blast
        }
        if(spd) this.spd = spd;
        else switch(this.typ) {
        case 0: // Blast
            this.spd.x = Math.cos(this.rot) * 30;
            this.spd.y = Math.sin(this.rot) * 30;
            break;
        case 1: // Explosion
            this.spd.x = Math.cos(this.rot) * 5;
            this.spd.y = Math.sin(this.rot) * 5;
            break;
        case 2: // Engine fire
            this.spd.x = Math.cos(this.rot) * 10;
            this.spd.y = Math.sin(this.rot) * 10;
            break;
        case 4: // Big blast
            this.spd.x = Math.cos(this.rot) * 30;
            this.spd.y = Math.sin(this.rot) * 30;
            break;
        case 5: // Small blast
            this.spd.x = Math.cos(this.rot) * 30;
            this.spd.y = Math.sin(this.rot) * 30;
            break;
        }
    }
}

function ship(pos, rot, typ, col) {
    this.pos = {x: 0, y: 0}; // Position
    this.spd = {x: 0, y: 0}; // Velocity
    this.nrm = {x: 1, y: 0}; // Normal (nose, based on rot)
    this.rot = 0; // Degrees rotated
    this.del = 0; // Rotation delta (how fast it's rotating)
    this.col = 0; // Team color
    this.wgt = 0; // Ship weight
    this.brn = 0; // Are thrusters in use or not
    this.acc = 0; // Acceleration
    this.trn = 0; // Is ship turning in any direction
    this.trg = 0; // Target ship ID
    this.stt = 0; // AI state (0 = attack, 1 = evade)
    this.fir = 0; // Ship is firing
    this.lod = 0; // Weapons are loading
    this.gns = 0; // Ship has weapons
    this.sys = 0; // This has system
    this.pts = 0; // Number of healthy parts
    this.var1 = 0; // When to start attacking
    this.var2 = 0; // When to start firing
    this.var3 = 0; // When to start evading
    this.respawn = 0; // Respawn timer
    this.p = new Array(); // List of parts
    
    // Function for creating a new ship
    this.createShip = function(id) {
        
        // Bogus numbers to prevent other ships from thinking this ship is already dead
        this.wgt = 1;
        this.acc = 1;
        this.gns = 1;
        this.sys = 1;
        this.pts = 1;
        this.var1 = Math.random(); // When to start attacking
        this.var2 = Math.random(); // When to start firing
        this.var3 = Math.random(); // When to start evading
        this.p = new Array();
        switch(id) {
        case 0: // Hornet
            this.p.push(part.create("anvil/hornet_big_gun", -3.0, -50.0, 2));
            this.p.push(part.create("anvil/hornet_big_gun", -3.0, 50.0, 3));
            this.p.push(part.create("anvil/hornet_wings_left", -5.0, -35.0, 6)); // 2
            this.p.push(part.create("anvil/hornet_wings_right", -5.0, 35.0, 6)); // 3
            this.p.push(part.create("anvil/hornet_intake_left", 15.0, -17.0, 6));
            this.p.push(part.create("anvil/hornet_intake_right", 15.0, 17.0, 6));
            this.p.push(part.create("anvil/hornet_main_hull", 0.0, 0.0, 6)); // 6
            this.p.push(part.create("anvil/hornet_thruster", -32.0, 0.0, 6));
            this.p.push(part.create("anvil/hornet_cockpit", 33.0, 0.0, 6)); // 8
            this.p.push(part.create("anvil/hornet_tail", -43.0, 0.0, 6));
            this.p.push(part.create("anvil/hornet_ball_turret", -3.0, 0.0, 6)); // 10
            this.p.push(part.create("anvil/hornet_big_gun", 3.0, -7.0, 10));
            this.p.push(part.create("anvil/hornet_big_gun", 3.0, 7.0, 10));
            this.p.push(part.create("shield3", -13.0, 0.0, 6));
            break;
        case 1: // Scythe
            this.p.push(part.create("vanduul/scythe_small_gun", 42.0, -13.0, 9)); // 0
            this.p.push(part.create("vanduul/scythe_small_gun", 42.0, -7.0, 9)); // 1
            this.p.push(part.create("vanduul/scythe_medium_gun", 30.0, -45.0, 4)); // 2
            this.p.push(part.create("vanduul/scythe_big_gun", 50.0, 40.0, 5)); // 3
            this.p.push(part.create("vanduul/scythe_gun_arm", 10.0, -30.0, 8)); // 4
            this.p.push(part.create("vanduul/scythe_blade_arm", 15.0, 32.0, 8)); // 5
            this.p.push(part.create("vanduul/scythe_thruster", -10.0, -10.0, 8)); // 6
            this.p.push(part.create("vanduul/scythe_thruster", -10.0, 10.0, 8)); // 7
            this.p.push(part.create("vanduul/scythe_main_hull", 0.0, 0.0, 8)); // 8
            this.p.push(part.create("vanduul/scythe_cockpit", 25.0, -10.0, 8)); // 9
            this.p.push(part.create("vanduul/scythe_blade", 62.0, 60.0, 5)); // 10
            this.p.push(part.create("shield4", 50.0, 0.0, 8));
            break;
        case 2: // Aurora
            this.p.push(part.create("vanduul/scythe_small_gun", 50.0, -12.0, 10));
            this.p.push(part.create("vanduul/scythe_small_gun", 50.0, 12.0, 10));
            this.p.push(part.create("rsi/aurora_intake_left", 31.0, -14.0, 9));
            this.p.push(part.create("rsi/aurora_intake_right", 31.0, 14.0, 9));
            this.p.push(part.create("rsi/aurora_wing_left", 3.0, -15.0, 9));
            this.p.push(part.create("rsi/aurora_wing_right", 3.0, 15.0, 9));
            this.p.push(part.create("rsi/aurora_wing_left", 3.0, -13.0, 9));
            this.p.push(part.create("rsi/aurora_wing_right", 3.0, 13.0, 9));
            this.p.push(part.create("rsi/aurora_thruster", -21.0, 0.0, 9));
            this.p.push(part.create("rsi/aurora_main_hull", 0.0, 0.0, 9)); // 9
            this.p.push(part.create("rsi/aurora_cockpit", 49.0, 0.0, 9)); // 10
            this.p.push(part.create("shield2", 20.0, 0.0, 9));
            break;
        case 3: // 300i
            this.p.push(part.create("vanduul/scythe_small_gun", 38.0, 0.0, 5));
            this.p.push(part.create("anvil/hornet_big_gun", -47.0, -42.0, 3));
            this.p.push(part.create("anvil/hornet_big_gun", -47.0, 42.0, 4));
            this.p.push(part.create("origin/300i_wing_left", -40.0, -23.0, 5)); // 3
            this.p.push(part.create("origin/300i_wing_right", -40.0, 23.0, 5)); // 4
            this.p.push(part.create("origin/300i_hull_front", 5.0, 0.0, 5)); // 5
            this.p.push(part.create("origin/300i_thruster", -70.0, 0.0, 7));
            this.p.push(part.create("origin/300i_hull_rear", -52.0, 0.0, 5)); // 7
            this.p.push(part.create("origin/300i_cockpit", 13.0, 0.0, 5));
            this.p.push(part.create("origin/300i_wing_top", -63.0, 0.0, 7));
            this.p.push(part.create("shield3", -20.0, 0.0, 5));
            break;
        case 4: // Glaive
            this.p.push(part.create("vanduul/scythe_small_gun", 42.0, 3.0, 9));
            this.p.push(part.create("vanduul/scythe_small_gun", 42.0, -3.0, 9));
            this.p.push(part.create("vanduul/scythe_big_gun_left", 50.0, -40.0, 4));
            this.p.push(part.create("vanduul/scythe_big_gun", 50.0, 40.0, 5));
            this.p.push(part.create("vanduul/scythe_blade_arm_left", 15.0, -32.0, 8)); // 4
            this.p.push(part.create("vanduul/scythe_blade_arm", 15.0, 32.0, 8)); // 5
            this.p.push(part.create("vanduul/scythe_thruster", -10.0, -10.0, 8));
            this.p.push(part.create("vanduul/scythe_thruster", -10.0, 10.0, 8));
            this.p.push(part.create("vanduul/scythe_main_hull", 0.0, 0.0, 8)); // 8
            this.p.push(part.create("vanduul/scythe_cockpit", 25.0, 0.0, 8)); // 9
            this.p.push(part.create("vanduul/scythe_blade_left", 62.0, -60.0, 4));
            this.p.push(part.create("vanduul/scythe_blade", 62.0, 60.0, 5));
            this.p.push(part.create("shield4", 50.0, 0.0, 8));
            break;
//         case 0: // Team 1 light fighter
//             this.p.push(part.create("blaster1", 25.0, 0.0, 2));
//             this.p.push(part.create("engine1", -35.0, 0.0, 2));
//             this.p.push(part.create("hull1", 0.0, 0.0, 2));
//             this.p.push(part.create("system1", -15.0, 0.0, 2));
//             break;
//         case 1: // Team 1 medium fighter
//             this.p.push(part.create("engine1", -35.0, 0.0, 1));
//             this.p.push(part.create("hull1", 0.0, 0.0, 1));
//             this.p.push(part.create("system1", -15.0, 0.0, 1));
//             this.p.push(part.create("blaster1left", -15.0, -22.0, 1));
//             this.p.push(part.create("blaster1right", -15.0, 22.0, 1));
//             break;
//         case 2: // Team 1 heavy fighter
//             this.p.push(part.create("blaster1left", -20.0, -22.0, 6));
//             this.p.push(part.create("blaster1right", -20.0, 22.0, 6));
//             this.p.push(part.create("blaster1left", 15.0, -12.0, 6));
//             this.p.push(part.create("blaster1right", 15.0, 12.0, 6));
//             this.p.push(part.create("engine1", -43.0, 14.0, 7));
//             this.p.push(part.create("engine1", -43.0, -14.0, 7));
//             this.p.push(part.create("hull1", 0.0, 0.0, 6));
//             this.p.push(part.create("hull3", -35.0, 0.0, 6));
//             this.p.push(part.create("system1", -15.0, 0.0, 6));
//             break;
//         case 3: // Team 2 light fighter
//             this.p.push(part.create("blaster1", 30.0, 0.0, 2));
//             this.p.push(part.create("engine2", -25.0, 0.0, 2));
//             this.p.push(part.create("hull2", 0.0, 0.0, 2));
//             this.p.push(part.create("system1", 0.0, 0.0, 2));
//             break;
//         case 4: // Team 2 medium fighter
//             this.p.push(part.create("blaster1left", -10.0, -20.0, 3));
//             this.p.push(part.create("blaster1right", -10.0, 20.0, 3));
//             this.p.push(part.create("engine2", -25.0, 0.0, 3));
//             this.p.push(part.create("hull2", 0.0, 0.0, 3));
//             this.p.push(part.create("system1", 0.0, 0.0, 3));
//             break;
//         case 5: // Team 2 heavy fighter
//             this.p.push(part.create("blaster1", 30.0, 0.0, 4));
//             this.p.push(part.create("blaster1left", -10.0, -20.0, 4));
//             this.p.push(part.create("blaster1right", -10.0, 20.0, 4));
//             this.p.push(part.create("engine2", -25.0, 0.0, 4));
//             this.p.push(part.create("hull2", 0.0, 0.0, 4));
//             this.p.push(part.create("system1", 0.0, 0.0, 4));
//             break;
//         case 6: // Team 3 light fighter
//             this.p.push(part.create("blaster1left", 15.0, -10.0, 3));
//             this.p.push(part.create("blaster1right", 15.0, 10.0, 3));
//             this.p.push(part.create("engine2", -5.0, 0.0, 3));
//             this.p.push(part.create("hull5", 0.0, 0.0, 3));
//             this.p.push(part.create("system2", 20.0, 0.0, 3));
//             break;
//         case 7: // Team 3 medium fighter
//             this.p.push(part.create("engine2", -25.0, 0.0, 2));
//             this.p.push(part.create("blaster1", 40.0, 0.0, 2));
//             this.p.push(part.create("hull4", 0.0, 0.0, 2));
//             this.p.push(part.create("system2", 20.0, 0.0, 2));
//             this.p.push(part.create("shield1", 0.0, 0.0, 2));
//             break;
//         case 8: // Team 3 heavy fighter
//             this.p.push(part.create("engine2", -35.0, 0.0, 4));
//             this.p.push(part.create("blaster1left", 5.0, -25.0, 4));
//             this.p.push(part.create("blaster1right", 5.0, 25.0, 4));
//             this.p.push(part.create("hull5", 30.0, 0.0, 3));
//             this.p.push(part.create("hull4", -10.0, 0.0, 3));
//             this.p.push(part.create("shield1", 0.0, 0.0, 4));
//             this.p.push(part.create("system2", 30.0, 0.0, 3));
//             break;
        }
    }
    
    // Function for drawing this ship
    this.drawShip = function(pos, rot) {
        var spd = (ispaused ? 0.1 : 1.0);
        if(!pos) pos = this.pos;
        if(!rot) rot = this.rot;
        this.wgt = 0;
        this.acc = 0;
        this.gns = 0; // Ship has weapons
        this.sys = 0; // This has system
        this.pts = 0; // Number of healthy parts
        for(var i = 0; i < this.p.length; i++) if(this.p[i].hlt > 0.0) if(this.p[this.p[i].parent].hlt > 0.0) {
            this.pts++;
            c.save();
            c.translate(
                pos.x + Math.cos(rot) * this.p[i].x - Math.sin(rot) * this.p[i].y,
                pos.y + Math.sin(rot) * this.p[i].x + Math.cos(rot) * this.p[i].y
            );
            c.rotate(rot);
            if(this.p[i].hlt < 0.2) part.draw(part.id(this.p[i].part + "broken"));
            else part.draw(part.id(this.p[i].part));
            switch(this.p[i].part) {
            case "hull1": this.wgt += 0.8; break;
            case "hull2": this.wgt += 0.7; break;
            case "hull3": this.wgt += 0.6; break;
            case "hull4": this.wgt += 0.8; break;
            case "hull5": this.wgt += 0.6; break;
            case "engine1":
                this.wgt += 0.2;
                if(this.p[i].hlt > 0.2) this.acc += 1.0;
                if(this.p[i].hlt > 0.2) if(this.brn && Math.random() < 0.3 * spd) {
                    b.push(new frag(
                        {
                            x: this.pos.x + this.nrm.x * (this.p[i].x - 15.0) - this.nrm.y * this.p[i].y,
                            y: pos.y + this.nrm.y * (this.p[i].x - 15.0) + this.nrm.x * this.p[i].y
                        },
                        this.rot + Math.PI + Math.random() * 1.4 - 0.7,
                        this.col,
                        2
                    )); 
                }
                break;
            case "engine2":
                this.wgt += 0.3;
                if(this.p[i].hlt > 0.2) this.acc += 1.2;
                if(this.p[i].hlt > 0.2) if(this.brn && Math.random() < 0.3 * spd) {
                    b.push(new frag(
                        {
                            x: this.pos.x + this.nrm.x * (this.p[i].x - 25.0) - this.nrm.y * this.p[i].y,
                            y: pos.y + this.nrm.y * (this.p[i].x - 25.0) + this.nrm.x * this.p[i].y
                        },
                        this.rot + Math.PI + Math.random() * 1.4 - 0.7,
                        this.col,
                        2
                    )); 
                }
                break;
            case "system1":
                this.wgt += 0.2;
                if(this.p[i].hlt > 0.2) this.sys++;
                break;
            case "system2":
                this.wgt += 0.2;
                if(this.p[i].hlt > 0.2) this.sys++;
                break;
            case "blaster1":
                this.wgt += 0.2;
                if(this.p[i].hlt > 0.2) this.gns++;
                break;
            case "blaster1left":
                this.wgt += 0.2;
                if(this.p[i].hlt > 0.2) this.gns++;
                break;
            case "blaster1right":
                this.wgt += 0.2;
                if(this.p[i].hlt > 0.2) this.gns++;
                break;
            case "shield1":
                this.wgt += 2.5;
                break;
            
            // Scythe parts
            case "vanduul/scythe_big_gun": this.wgt += 0.5; if(this.p[i].hlt > 0.2) this.gns++; break;
            case "vanduul/scythe_blade": this.wgt += 1.5; break;
            case "vanduul/scythe_gun_arm": this.wgt += 0.4; break;
            case "vanduul/scythe_medium_gun": this.wgt += 0.4; if(this.p[i].hlt > 0.2) this.gns++; break;
            case "vanduul/scythe_blade_arm": this.wgt += 0.5; break;
            case "vanduul/scythe_cockpit": this.wgt += 0.2; if(this.p[i].hlt > 0.2) this.sys++; break;
            case "vanduul/scythe_main_hull": this.wgt += 1.5; break;
            case "vanduul/scythe_small_gun": this.wgt += 0.2; if(this.p[i].hlt > 0.2) this.gns++; break;
            case "vanduul/scythe_thruster":
                this.wgt += 0.4;
                if(this.p[i].hlt > 0.2) this.acc += 2.0;
                if(this.p[i].hlt > 0.2) if(this.brn && Math.random() < 0.3 * spd) {
                    b.push(new frag(
                        {
                            x: this.pos.x + this.nrm.x * (this.p[i].x - 15.0) - this.nrm.y * this.p[i].y,
                            y: pos.y + this.nrm.y * (this.p[i].x - 15.0) + this.nrm.x * this.p[i].y
                        },
                        this.rot + Math.PI + Math.random() * 1.4 - 0.7,
                        this.col,
                        2
                    )); 
                }
                break;
        
            // Hornet parts
            case "anvil/hornet_ball_turret": this.wgt += 0.5; break;
            case "anvil/hornet_big_gun": this.wgt += 0.4; if(this.p[i].hlt > 0.2) this.gns++; break;
            case "anvil/hornet_cockpit": this.wgt += 0.3; if(this.p[i].hlt > 0.2) this.sys++; break;
            case "anvil/hornet_intake_left": this.wgt += 0.2; break;
            case "anvil/hornet_intake_right": this.wgt += 0.2; break;
            case "anvil/hornet_main_hull": this.wgt += 1.5; break;
            case "anvil/hornet_tail": this.wgt += 0.3; break;
            case "anvil/hornet_thruster":
                this.wgt += 0.4;
                if(this.p[i].hlt > 0.2) this.acc += 3.0;
                if(this.p[i].hlt > 0.2) if(this.brn && Math.random() < 0.3 * spd) {
                    b.push(new frag(
                        {
                            x: this.pos.x + this.nrm.x * (this.p[i].x - 15.0) - this.nrm.y * this.p[i].y,
                            y: pos.y + this.nrm.y * (this.p[i].x - 15.0) + this.nrm.x * this.p[i].y
                        },
                        this.rot + Math.PI + Math.random() * 1.4 - 0.7,
                        this.col,
                        2
                    )); 
                }
                break;
            case "anvil/hornet_wings_left": this.wgt += 0.5; break;
            case "anvil/hornet_wings_right": this.wgt += 0.5; break;
        
            // Aurora parts
            case "rsi/aurora_cockpit": this.wgt += 0.5; if(this.p[i].hlt > 0.2) this.sys++; break;
            case "rsi/aurora_intake_left": this.wgt += 0.2; break;
            case "rsi/aurora_intake_right": this.wgt += 0.2; break;
            case "rsi/aurora_main_hull": this.wgt += 0.7; break;
            case "rsi/aurora_thruster":
                this.wgt += 0.3;
                if(this.p[i].hlt > 0.2) this.acc += 1.5;
                if(this.p[i].hlt > 0.2) if(this.brn && Math.random() < 0.3 * spd) {
                    b.push(new frag(
                        {
                            x: this.pos.x + this.nrm.x * (this.p[i].x - 15.0) - this.nrm.y * this.p[i].y,
                            y: pos.y + this.nrm.y * (this.p[i].x - 15.0) + this.nrm.x * this.p[i].y
                        },
                        this.rot + Math.PI + Math.random() * 1.4 - 0.7,
                        this.col,
                        2
                    )); 
                }
                break;
            case "rsi/aurora_wing_left": this.wgt += 0.3; break;
            case "rsi/aurora_wing_right": this.wgt += 0.3; break;
            
            // 300i parts
            case "origin/300i_cockpit": this.wgt += 0.4; if(this.p[i].hlt > 0.2) this.sys++; break;
            case "origin/300i_hull_front": this.wgt += 0.6; break;
            case "origin/300i_hull_rear": this.wgt += 0.5; break;
            case "origin/300i_thruster":
                this.wgt += 0.5;
                if(this.p[i].hlt > 0.2) this.acc += 2.5;
                if(this.p[i].hlt > 0.2) if(this.brn && Math.random() < 0.3 * spd) {
                    b.push(new frag(
                        {
                            x: this.pos.x + this.nrm.x * (this.p[i].x - 15.0) - this.nrm.y * this.p[i].y,
                            y: pos.y + this.nrm.y * (this.p[i].x - 15.0) + this.nrm.x * this.p[i].y
                        },
                        this.rot + Math.PI + Math.random() * 1.4 - 0.7,
                        this.col,
                        2
                    )); 
                }
                break;
            case "origin/300i_wing_left": this.wgt += 0.3; break;
            case "origin/300i_wing_right": this.wgt += 0.3; break;
            case "origin/300i_wing_top": this.wgt += 0.3; break;
        
            // Glaive parts
            case "vanduul/scythe_big_gun_left": this.wgt += 0.5; if(this.p[i].hlt > 0.2) this.gns++; break;
            case "vanduul/scythe_blade_left": this.wgt += 1.5; break;
            case "vanduul/scythe_blade_arm_left": this.wgt += 0.5; break;
            
            // Shields
            case "shield2": this.wgt += 0.01; if(this.p[i].hlt < 6.0) this.p[i].hlt += spd * 0.01; break;
            case "shield3": this.wgt += 0.01; if(this.p[i].hlt < 9.0) this.p[i].hlt += spd * 0.01; break;
            case "shield4": this.wgt += 0.01; if(this.p[i].hlt < 7.0) this.p[i].hlt += spd * 0.01; break;
            }
            c.restore();
        } else {
            this.p[i].hlt = 0;
            
            // Detatch broken part
            b.push(new frag(
                {
                    x: this.pos.x + this.nrm.x * this.p[i].x - this.nrm.y * this.p[i].y,
                    y: this.pos.y + this.nrm.y * this.p[i].x + this.nrm.x * this.p[i].y
                },
                Math.random() * 6.3,
                this.col,
                3, this.p[i].part,
                this.del + Math.random() * 0.1 - 0.5,
                {x: this.spd.x + Math.random() * 2.0 - 1.0, y: this.spd.y + Math.random() * 2.0 - 1.0}
            ));
        }
        
        // Create new ship if this ship is dead
        if(!this.pts && !waitforit) {
            if(!this.respawn) this.respawn = 150;
            else this.respawn--;
            if(!this.respawn) {
                var deg = Math.random() * Math.PI * 2.0;
                this.col = Math.floor(Math.random() * 3);
                this.pos = {x:Math.cos(deg) * 7000, y:Math.sin(deg) * 7000};
                this.rot = Math.random() * Math.PI * 2.0;
                switch(this.col) {
                case 0: // Military
                    var curship = 0; // Hornet
                    break;
                case 1: // Vanduul
                    switch(Math.floor(Math.random() * 3.0)) {
                    case 0: case 1: var curship = 1; break; // Scythe
                    case 2: var curship = 4; break; // Glaive
                    }
                    break;
                case 2: // Civilian
                    switch(Math.floor(Math.random() * 2.0)) {
                    case 0: var curship = 2; break; // Aurora
                    case 1: var curship = 3; break; // 300i
                    }
                    break;
                }
                this.createShip(curship);
                this.trg = Math.floor(Math.random() * a.length);
                
                // Give ship full speed towards center
                this.spd = {
                    x: -this.pos.x * 0.015,
                    y: -this.pos.y * 0.015
                }
                
                // Create a respawn "blast"
                for(var u = 0; u < 10; u++) b.push(new frag(
                    {x: this.pos.x, y: this.pos.y},
                    Math.random() * Math.PI * 2.0,
                    this.col, 2
                ));
            }
        }
    }
    
    // Move this ship
    this.moveShip = function() {
        var spd = (ispaused ? 0.1 : 1.0);
        if(this.wgt) {
            
            // Movement
            this.pos.x += this.spd.x * spd;
            this.pos.y += this.spd.y * spd;
            this.rot += this.del * spd;
            this.nrm = {x: Math.cos(this.rot), y: Math.sin(this.rot)};
            
            // Acceleration
            if(this.brn && this.acc > 0) {
                this.spd.x += this.nrm.x * (this.acc / this.wgt) * 0.8;
                this.spd.y += this.nrm.y * (this.acc / this.wgt) * 0.8;
            }
            
            // Turning
            if(this.trn && this.acc > 0) {
                this.del += this.trn * (this.acc / this.wgt) * 0.02;
            }
            
            // Friction (I know, it's fake space)
            //  * Apply drifting for crippled ships, though
            if(this.sys && this.acc) {
                this.spd.x *= 0.97;
                this.spd.y *= 0.97;
                this.del *= 0.9;
            }
            
            // Shooting
            if(this.gns) {
                if(this.lod > 0) this.lod -= spd;
                if(this.fir && this.lod <= 0) {
                    this.lod = 15; // Load time 15 frames
                    
                    // Create bullets
                    for(i = 0; i < this.p.length; i++) if(this.p[i].hlt >= 0.2) {
                        switch(this.p[i].part) {
                        case "blaster1":
                        case "blaster1left":
                        case "blaster1right":
                        case "vanduul/scythe_medium_gun":
                        case "anvil/hornet_big_gun":
                            b.push(new frag(
                                {
                                    x: this.pos.x + this.nrm.x * this.p[i].x - this.nrm.y * this.p[i].y,
                                    y: this.pos.y + this.nrm.y * this.p[i].x + this.nrm.x * this.p[i].y
                                },
                                this.rot,
                                this.col, 0, false, false,
                                {x: this.spd.x + this.nrm.x * 30.0, y: this.spd.y + this.nrm.y * 30.0}
                                //pos, rot, col, typ, sub, del, spd
                            ));
                            break;
                        case "vanduul/scythe_small_gun":
                            b.push(new frag(
                                {
                                    x: this.pos.x + this.nrm.x * this.p[i].x - this.nrm.y * this.p[i].y,
                                    y: this.pos.y + this.nrm.y * this.p[i].x + this.nrm.x * this.p[i].y
                                },
                                this.rot,
                                this.col, 5, false, false,
                                {x: this.spd.x + this.nrm.x * 30.0, y: this.spd.y + this.nrm.y * 30.0}
                                //pos, rot, col, typ, sub, del, spd
                            ));
                            break;
                        case "vanduul/scythe_big_gun":
                        case "vanduul/scythe_big_gun_left":
                            b.push(new frag(
                                {
                                    x: this.pos.x + this.nrm.x * this.p[i].x - this.nrm.y * this.p[i].y,
                                    y: this.pos.y + this.nrm.y * this.p[i].x + this.nrm.x * this.p[i].y
                                },
                                this.rot,
                                this.col, 4, false, false,
                                {x: this.spd.x + this.nrm.x * 30.0, y: this.spd.y + this.nrm.y * 30.0}
                                //pos, rot, col, typ, sub, del, spd
                            ));
                            break;
                        }
                    }
                }
            }
        }
    }
    
    // Perform AI tasks
    this.thinkShip = function(followed) {
        if(!this.sys || waitforit) {
            this.brn = 0;
            this.fir = 0;
            this.trn = 0;
            return;
        }
        
        // Don't follow a disabled target
        if(!a[this.trg].sys || !a[this.trg].gns || !a[this.trg].acc) this.trg = Math.floor(Math.random() * a.length);
        
        // Follow target
        if(a[this.trg].wgt && a[this.trg].col != this.col) {
            
            // Get targets position relative to self
            var pos = {
                x: a[this.trg].pos.x - this.pos.x,
                y: a[this.trg].pos.y - this.pos.y
            };
            
            // Get distance and normal to target
            var dis = Math.sqrt(pos.x * pos.x + pos.y * pos.y);
            
            // Look for closer target if too far
            if(dis > 2000) {
                var tmptrg = Math.floor(Math.random() * a.length);
                if(a[tmptrg].sys && a[tmptrg].gns && a[tmptrg].acc && a[tmptrg].wgt && a[tmptrg].col != this.col) {
                    var tmppos = {
                        x: a[tmptrg].pos.x - this.pos.x,
                        y: a[tmptrg].pos.y - this.pos.y
                    };
                    var tmpdis = Math.sqrt(tmppos.x * tmppos.x + tmppos.y * tmppos.y);
                    if(tmpdis < dis) {
                        this.trg = tmptrg;
                        pos = tmppos;
                        dis = tmpdis;
                    }
                }
            }
            
            // Calculate normal towards target
            if(dis) var nrm = {x: pos.x / dis, y: pos.y / dis};
            else var nrm = {x: 1, y: 0};
            
            // Draw a target indicator
            c.beginPath();
            c.moveTo(this.pos.x + nrm.x * 70 ,this.pos.y + nrm.y * 70);
            c.lineTo(this.pos.x + nrm.x * 90 ,this.pos.y + nrm.y * 90);
            c.closePath();
            c.stroke();
            
            // Get human input
            if(followed && hascontrol && !iskeyboardcontrol) {
                pos = trg;
                dis = Math.sqrt(pos.x * pos.x + pos.y * pos.y);
                if(dis) nrm = {x: pos.x / dis, y: pos.y / dis};
                else nrm = {x: 1, y: 0};
            }
            
            // Get extruded dot value to target
            var dot = this.nrm.x * -nrm.y + this.nrm.y * nrm.x;
            
            // Get normal dot value to target
            var dot2 = this.nrm.x * nrm.x + this.nrm.y * nrm.y;
            
            // Follow target or evade it
            if(dis > 700 + this.var1 * 400) this.stt = 0;
            else if(dis < 500 + this.var3 * 400) this.stt = 1;
            
            // Always evade if no weapons
            if(!this.gns) this.stt = 1;
            
            // Controlled ship always follows target
            if(followed && hascontrol) this.stt = 0;
            
            // Follow mode
            if(this.stt == 0) {
                
                // If target is to the right, turn right, and vice versa
                //  * Don't turn with full force if target is already in front of ship and still turning towards it (reduces swaying)
                if(dot2 > 0.0) {
                    if(dot > 0.0) this.trn = -dot;
                    else this.trn = -dot;
                } else {
                    if(dot > 0.0) this.trn = -1.0;
                    else this.trn = 1.0;
                }
                
                // Accelerate if target is in front of ship
                if(dot2 > 0.7) this.brn = 1;
                else this.brn = 0;
                
                // Shoot target if within range
                if(dis < 900 + this.var2 * 500 && dot2 > 0.9) this.fir = 1;
                else this.fir = 0;
                
                // Get shooting and turning for human controlled ship
                if(followed && hascontrol) {
                    this.fir = isshooting;
                    if(iskeyboardcontrol) {
                        this.trn = isturning;
                        this.brn = isaccelerating;
                    }
                }
            
            // Evade target if too close
            } else if(this.stt == 1) {
                this.fir = 0; // No firing because the game would be too difficult
                
                // If target is to the right, turn right, and vice versa
                if(dot2 > 0.0) {
                    if(dot > 0.0) this.trn = 1.0;
                    else this.trn = -1.0;
                } else {
                    
                    // Don't turn with full force if target is already behind the ship (reduces swaying)
                    if(dot > 0.0) this.trn = dot;
                    else this.trn = dot;
                }
                
                // Accelerate if target is behind the ship
                if(dot < 0.5) this.brn = 1;
                else this.brn = 0;
            }
        
        // Find new target
        } else {
            this.trg = Math.floor(Math.random() * a.length);
        }
    }
    
    // Init ship
    if(pos) this.pos = pos;
    if(rot) this.rot = rot;
    this.createShip(typ);
    if(col) this.col = col;
    this.trg = Math.floor(Math.random() * a.length);
}
var a = new Array();
a.push(new ship({x:0, y:0}, 0, Math.floor(Math.random() * 5),0));
var b = new Array();

function init() {
    
    // Get canvas
    canvas = document.getElementById('canvas');
    c = canvas.getContext('2d');
    
    // Load images
    part.init();
    doneload();
}

// Draw loading graph and start loop when done
function doneload() {
    toload--;
    if(!toload) setInterval(loop, 25);
}

// The main loop
function loop() {
    var spd = (ispaused ? 0.1 : 1.0);
    if(waitforit > 0) {
        waitforit -= spd;
        zoomtrg = zoomtrg * 0.99;
        if(waitforit <= 0) {
            players = 12;
            var curteam = 0;
            var curship = 0;
            a = new Array();
            for(var i = 0; i < players; i++) {
                curteam = i%3;
                
                // Team 2 needs fewer ships to balance the game
                switch(curteam) {
                case 0: // Military
                    curship = 0; // Hornet
                    break;
                case 1: // Vanduul
                    switch(Math.floor(Math.random() * 3.0)) {
                    case 0: case 1: curship = 1; break; // Scythe
                    case 2: curship = 4; break; // Glaive
                    }
                    break;
                case 2: // Civilian
                    switch(Math.floor(Math.random() * 2.0)) {
                    case 0: curship = 2; break; // Aurora
                    case 1: curship = 3; break; // 300i
                    }
                }
                a.push(new ship(
                    {x:Math.cos(curteam * Math.PI * 0.66 + i * 0.1) * 5000 + Math.random() * 500 - 250, y:Math.sin(curteam * Math.PI * 0.66 + i * 0.1) * 5000 + Math.random() * 500 - 250}, // Position
                    Math.random() * Math.PI * 2.0, // Direction
                    curship, // Ship configuration
                    curteam // Team
                ));
            }
            b = new Array();
            camid = Math.floor(Math.random() * 3);
            cam = a[camid].pos;
            zoomtrg = 1.0;
            waitcam = 0;
        }
    } else waitforit = 0;

    // Clear background
    c.fillStyle = "rgb(240,240,250)";
    c.strokeStyle = "rgb(150,0,0)";
    c.fillRect(0, 0, canvas.width, canvas.height);
    
    // Camera follows a[camid].pos and scene is zoomed out to view both a[camid] and its target
    //  * camid selects a healthy ship
    if(!a[camid].sys || !a[camid].gns || !a[camid].acc) {
        camid = Math.floor(Math.random() * a.length);
        waitcam = 50; // Wait 50 framse until view switch
        hascontrol = 0;
    } else if(waitcam < 1) {
        cam = a[camid].pos;
        if(!waitforit) {
            zoomtrg = 1.0 + Math.sqrt((a[a[camid].trg].pos.x - a[camid].pos.x) * (a[a[camid].trg].pos.x - a[camid].pos.x) + (a[a[camid].trg].pos.y - a[camid].pos.y) * (a[a[camid].trg].pos.y - a[camid].pos.y)) * 0.0025;
            if(zoomtrg > 4.0) zoomtrg = 4.0;
        }
    } else waitcam -= spd;
    zoom = zoom + (zoomtrg - zoom) * 0.1;
    c.save();
    c.scale(1 / zoom, 1 / zoom);
    c.translate(-cam.x + canvas.width * 0.5 * zoom,-cam.y + canvas.height * 0.5 * zoom);
    
    var teams = new Array(0,0,0);
    var tmp_part = 0;
    for(var i = 0; i < a.length; i++) {
        c.save();
        a[i].moveShip();
        a[i].drawShip();
        a[i].thinkShip(i == camid);
        c.restore();
        if(a[i].sys && a[i].gns && a[i].acc) teams[a[i].col]++;
        
        // Self destruct if disabled
        else if(a[i].pts > 0) {
            tmp_part = Math.floor(Math.random() * a[i].p.length);
            if(a[i].p[tmp_part].hlt > 0.0) {
                a[i].p[tmp_part].hlt -= Math.random() * 0.05;
                if(a[i].p[tmp_part].hlt <= 0.0) {
                    b.push(new frag(
                        {
                            x: a[i].pos.x + a[i].nrm.x * a[i].p[tmp_part].x - a[i].nrm.y * a[i].p[tmp_part].y,
                            y: a[i].pos.y + a[i].nrm.y * a[i].p[tmp_part].x + a[i].nrm.x * a[i].p[tmp_part].y
                        },
                        Math.random() * 6.3,
                        a[i].col,
                        3, a[i].p[tmp_part].part
                    ));
                }
            }
        }
    }
    
    var tosplice = new Array();
    for(var i = 0; i < b.length; i++) {
        c.save();
        b[i].moveFrag();
        b[i].drawFrag();
        c.restore();
        if(b[i].lif <= 1) tosplice.push(i);
    }
    if(tosplice.length) for(var i = tosplice.length - 1; i >= 0; i--) b.splice(tosplice[i], 1);
    c.restore();
    
    // Timer for human control
    if(hascontrol > 0) hascontrol--;
    else hascontrol = 0;
    
    // Restart game
    var multi = 0;
    for(var i = 0; i < teams.length; i++) if(teams[i]) multi++;
    if(multi < 2 && waitforit <= 0)  waitforit = 200;
    else document.getElementById('asdf').innerHTML = "Ships per team: " + teams + "<br/>Teams left: " + multi;
}

function movetarget(e) {
    if(hascontrol) {
        hascontrol = 500;
        trg = {
            x: (e.clientX - canvas.width * 0.5) * zoom,
            y: (e.clientY - canvas.height * 0.5) * zoom
        }
    }
}
function startshooting() {
    if(hascontrol) isshooting = true;
    hascontrol = 500;
    iskeyboardcontrol = false;
}
function stopshooting() {
    isshooting = false;
}
function startkeyinput(e) {
    switch(e.keyCode) {
    case 81:
        if(hascontrol) isshooting = true;
        iskeyboardcontrol = true;
        hascontrol = 500;
        break;
    case 73:
        if(hascontrol) isaccelerating = true;
        iskeyboardcontrol = true;
        hascontrol = 500;
        break;
    case 74:
        if(hascontrol) isturning = -1;
        iskeyboardcontrol = true;
        hascontrol = 500;
        break;
    case 76:
        if(hascontrol) isturning = 1;
        iskeyboardcontrol = true;
        hascontrol = 500;
        break;
    }
}
function stopkeyinput(e) {
    switch(e.keyCode) {
    case 80: ispaused = (ispaused ? false : true); break; // P for pause, which is actually just slow motion toggle
    case 81: isshooting = false; break;
    case 73: isaccelerating = false; break;
    case 74: isturning = 0; break;
    case 76: isturning = 0; break;
    }
}
</script>
</head>
<body onload='init()' onmouseup='stopshooting(event)' style='margin: 0px;' onkeydown='startkeyinput(event)' onkeyup='stopkeyinput(event)'>
<p><a href='http://robertsspaceindustries.com/'>Star Citizen Arena Commander</a> mod for Cartoon Space</p>
<canvas id="canvas" width='1200' height='800' onmousedown='startshooting()' onmousemove='movetarget(event)'></canvas>
<p id="asdf"></p><p id="debug">Accelerate: I, Turn left: J, Turn right: L, Fire: Q, Slow motion: P</p>
</body>
</html>
